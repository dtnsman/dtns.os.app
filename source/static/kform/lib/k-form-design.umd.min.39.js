(("undefined"!==typeof self?self:this)["webpackJsonpk_form_design"]=("undefined"!==typeof self?self:this)["webpackJsonpk_form_design"]||[]).push([[39],{"1f3b":function(e,t,i){"use strict";i.r(t);var n=function(){var e=this,t=e._self._c;return t("div",{staticClass:"upload-img-box-9136076486841527",style:{width:e.record.options.width}},[t("Upload",{attrs:{name:e.config.uploadImageName||e.record.options.fileName,headers:e.config.uploadImageHeaders||e.record.options.headers,data:e.config.uploadImageData||e.optionsData,action:e.config.uploadImage||e.record.options.action,multiple:e.record.options.multiple,listType:e.record.options.listType,disabled:e.record.options.disabled||e.parentDisabled,fileList:e.fileList,accept:"image/gif, image/jpeg, image/png",remove:e.remove,beforeUpload:e.beforeUpload},on:{change:e.handleChange,preview:e.handlePreview}},["picture-card"!==e.record.options.listType&&e.fileList.length<e.record.options.limit?t("Button",{attrs:{disabled:e.record.options.disabled||e.parentDisabled}},[t("a-icon",{attrs:{type:"upload"}}),e._v(" "+e._s(e.record.options.placeholder)+" ")],1):e._e(),"picture-card"===e.record.options.listType&&e.fileList.length<e.record.options.limit?t("div",{attrs:{disabled:e.record.options.disabled||e.parentDisabled}},[t("a-icon",{attrs:{type:"plus"}}),t("div",{staticClass:"ant-upload-text"},[e._v(e._s(e.record.options.placeholder))])],1):e._e()],1),t("a-modal",{attrs:{visible:e.previewVisible,footer:null},on:{cancel:e.handleCancel}},[t("img",{staticStyle:{width:"100%"},attrs:{alt:"example",src:e.previewImageUrl}})])],1)},a=[],s=(i("f751"),i("551c"),i("96cf"),i("1da1")),o=(i("7f7f"),i("e74d")),l=i("f64c"),r=o["c"].getComponent("upload"),d=o["c"].getComponent("aButton").component,c={name:"KUploadImg",props:["record","value","config","parentDisabled"],components:{Upload:r.component,Button:d},data:function(){return{fileList:[],previewVisible:!1,previewImageUrl:""}},watch:{value:{handler:function(e){e&&this.setFileList()},immediate:!0,deep:!0}},computed:{optionsData:function(){try{return JSON.parse(this.record.options.data)}catch(e){return console.error(e),{}}}},methods:{setFileList:function(){"string"===typeof this.value?(this.fileList=JSON.parse(this.value),this.handleSelectChange()):this.fileList=this.value},handleSelectChange:function(){var e=this;setTimeout((function(){var t=e.fileList.map((function(e){return"undefined"!==typeof e.response?{type:"img",name:e.name,status:e.status,uid:e.uid,url:e.url,thumbUrl:e.thumbUrl}:{type:"img",name:e.name,status:e.status,uid:e.uid,url:e.url||"",thumbUrl:e.thumbUrl}}));e.$emit("change",t),e.$emit("input",t)}),10)},handlePreview:function(e){this.previewImageUrl=e.url||e.thumbUrl,this.previewVisible=!0},handleCancel:function(){this.previewVisible=!1},remove:function(){this.handleSelectChange()},beforeUpload:function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,i){var n,a,s,o,r,d;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(i.length+this.fileList.length>this.record.options.limit&&(l["a"].warning("最大上传数量为".concat(this.record.options.limit)),i.splice(this.record.options.limit-this.fileList.length)),console.log("beforeUpload:files:",i,t),console.log("fileList:",this.fileList),n=window.g_dtnsManager,console.log("g_dtnsManager:",n),"undefined"==typeof n){e.next=32;break}return console.log("g_dtnsManager:",n),a={file:t},s={fieldname:"file",encoding:"fromfile_binary",originalname:a.file.name,mimetype:a.file.type,filename:a.file.name,path:"file-path",size:a.file.size,user_id:localStorage.user_id,s_id:localStorage.s_id,img_kind:"open",random:Math.random(),data:a.file,img_q:.1},o=window.rpc_client,e.next=12,new Promise((function(e){o.sendImage(s,(function(t){console.log("sendFile-callback-data:"+JSON.stringify(t)),e(t)}))}));case 12:if(r=e.sent,console.log("upload-file-ret:"+JSON.stringify(r)),r.data.ret){e.next=18;break}console.log("上传失败"+r.data.msg,3e3),e.next=32;break;case 18:return console.log("上传成功"+r.data.msg,3e3),d={type:"img",name:a.file.name,status:"done",uid:a.file.uid,url:r.data.filename,originFileObj:{uid:a.file.uid},xhr:{},response:"ok",percent:0,lastModified:1685528081370,lastModifiedDate:"2023-05-31T10:14:41.370Z"},e.t0=console,e.next=23,window.imageDb.getDataByKey(d.url);case 23:return e.t1=e.sent,e.t0.log.call(e.t0,"await window.imageDb.getDataByKey(resultObj.url):",e.t1),e.next=27,window.imageDb.getDataByKey(d.url);case 27:d.thumbUrl=e.sent.data,console.log("resultObj:",d),this.resultObj=d,this.fileList.push(d),console.log("push-fileList:",this.fileList);case 32:case"end":return e.stop()}}),e,this)})));function t(t,i){return e.apply(this,arguments)}return t}(),handleChange:function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:this.fileList=t.fileList,"done"===t.file.status?(i=t.file.response,0===i.code||Object.assign(this.fileList[this.fileList.length-1],this.resultObj)):"error"===t.file.status&&Object.assign(this.fileList[this.fileList.length-1],this.resultObj),this.handleSelectChange();case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()}},u=c,p=i("2877"),f=Object(p["a"])(u,n,a,!1,null,null,null),h=f.exports;t["default"]=h}}]);