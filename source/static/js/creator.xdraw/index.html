<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Excalidraw | Hand-drawn look & feel • Collaborative • Secure</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, shrink-to-fit=no"
    />
    <meta name="referrer" content="origin" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#121212" />

    <!-- Primary Meta Tags -->
    <meta
      name="title"
      content="Excalidraw — Collaborative whiteboarding made easy"
    />
    <meta
      name="description"
      content="Excalidraw is a virtual collaborative whiteboard tool that lets you easily sketch diagrams that have a hand-drawn feel to them."
    />
    <meta name="image" content="https://excalidraw.com/og-image-2.png" />

    <!-- Open Graph / Facebook -->
    <meta property="og:site_name" content="Excalidraw" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://excalidraw.com" />
    <meta
      property="og:title"
      content="Excalidraw — Collaborative whiteboarding made easy"
    />
    <meta property="og:image:alt" content="Excalidraw logo" />
    <meta
      property="og:description"
      content="Excalidraw is a virtual collaborative whiteboard tool that lets you easily sketch diagrams that have a hand-drawn feel to them."
    />
    <meta property="og:image" content="https://excalidraw.com/og-image-2.png" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:site" content="@excalidraw" />
    <meta property="twitter:url" content="https://excalidraw.com" />
    <meta
      property="twitter:title"
      content="Excalidraw — Collaborative whiteboarding made easy"
    />
    <meta
      property="twitter:description"
      content="Excalidraw is a virtual collaborative whiteboard tool that lets you easily sketch diagrams that have a hand-drawn feel to them."
    />
    <meta
      property="twitter:image"
      content="https://excalidraw.com/og-twitter-v2.png"
    />

    <!-- General tags -->
    <meta
      name="description"
      content="Excalidraw is a virtual collaborative whiteboard tool that lets you easily sketch diagrams that have a hand-drawn feel to them."
    />

    <!------------------------------------------------------------------------->
    <!--   to minimize white flash on load when user has dark mode enabled   -->
    <script>
      try {
        //
        const theme = window.localStorage.getItem("excalidraw-theme");
        if (theme === "dark") {
          document.documentElement.classList.add("dark");
        }
      } catch {}
    </script>
    <style>
      html.dark {
        background-color: #121212;
        color: #fff;
      }
    </style>
    <!------------------------------------------------------------------------->
    

    <link rel="apple-touch-icon" sizes="180x180" href="https://static.dtns.top/xdraw/build/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="https://static.dtns.top/xdraw/build/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="https://static.dtns.top/xdraw/build/favicon-16x16.png" />

    <!-- Excalidraw version -->
    <meta name="version" content="2023-11-02T04:44:03.329Z-none" />

    <link
      rel="preload"
      href="https://static.dtns.top/xdraw/build/Virgil.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="https://static.dtns.top/xdraw/build/Cascadia.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="https://static.dtns.top/xdraw/build/fonts.css" type="text/css" />
    
    <script>
      window.EXCALIDRAW_ASSET_PATH = "/";
      // setting this so that libraries installation reuses this window tab.
      window.name = "_excalidraw";
    </script>

    <!-- FIXME: remove this when we update CRA (fix SW caching) -->
    <style>
      body,
      html {
        margin: 0;
        -webkit-text-size-adjust: 100%;

        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      .visually-hidden {
        position: absolute !important;
        height: 1px;
        width: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
        white-space: nowrap;
        user-select: none;
      }

      #root {
        height: 100%;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      @media screen and (min-width: 1200px) {
        #root {
          -webkit-touch-callout: default;
          -webkit-user-select: auto;
          -khtml-user-select: auto;
          -moz-user-select: auto;
          -ms-user-select: auto;
          user-select: auto;
        }
      }
    </style>
    <script type="module" crossorigin src="https://static.dtns.top/xdraw/build/assets/index-7f7828f0.js"></script>
    <link rel="stylesheet" href="https://static.dtns.top/xdraw/build/assets/index-bea72a37.css">
  <link rel="manifest" href="https://static.dtns.top/xdraw/build/manifest.webmanifest"></head>

  <body>
    <noscript> You need to enable JavaScript to run this app. </noscript>
    <header>
      <h1 class="visually-hidden">Excalidraw</h1>
    </header>
    <div id="root"></div>
    
    
    <!-- 100% privacy friendly analytics -->
    <script>
      class IFileIndexDB{
        constructor(dbname='ifiledb',storeName = 'ifilecache')
        {
            this.dbname = dbname
            this.db = null;
            this.version = 1
            this.storeName = storeName
            // this.cached = new Map()
        }
        async openDB() {
            let This = this
            // var version = version || 1;
            var request = window.indexedDB.open(this.dbname,this.version);

            await new Promise((res)=>{
                request.onerror = function (e) {
                    console.log(e.currentTarget.error.message);
                    res(null)
                };
                request.onsuccess = function (e) {
                    This.db = e.target.result;
                    res(This.db)
                };
                request.onupgradeneeded = function (e) {
                    var db = e.target.result;
                    if (!db.objectStoreNames.contains(This.storeName)) {
                        var store = db.createObjectStore(This.storeName, { keyPath: 'key' ,autoIncrement:false});
                        store.createIndex('key', 'key', { unique: true });
                    }
                    console.log('DB version changed to ' + This.version);
                };
            })
            console.log('opened-db:',This.db)
            return This.db
        }

        closeDB() {
            this.db.close();
        }

        deleteDB(name) {
            indexedDB.deleteDatabase(name);
        }

        addData( data ) {
            if(!data || !data.key) return null
            if(data && !data.data)
                return null

            var transaction = this.db.transaction(this.storeName, 'readwrite');
            var store = transaction.objectStore(this.storeName)
            store.add(data);
            return true
            // this.cached.set(data.key,data)
        }

        addDataByKey(data,key)
        {
            // if(!data || !data.key) return null
            // if(data && !data.data)
            //     return null

            var transaction = this.db.transaction(this.storeName, 'readwrite');
            var store = transaction.objectStore(this.storeName)
            store.add(data,key);
            return true
        }

        async getDataByKey(key) {
            if(!key) return null
            // if(this.cached.has(key)){
            //     let result = this.cached.get(key)
            //     //如果存储了为空的内容，直接返回null，并清理缓存。
            //     if(result  && !result.data) 
            //     {
            //         this.deleteDataByKey(request.key)
            //         return null;
            //     }
            //     else 
            //         return result
            // } 

            let This = this
            var transaction = this.db.transaction(this.storeName, 'readwrite');
                var store = transaction.objectStore(this.storeName);
            let data = await new Promise((res)=>{
                try{
                    var request = store.get(key);
                    request.onsuccess = function (e) {
                        var result = e.target.result;
                        if(result  && !result.data) 
                        {
                            This.deleteDataByKey(request.key)
                            return res(null)
                        }
                        res(result)
                    };
                    request.onerror = function(e) {
                        console.log('[Error]ImageIndexDB-getDataByKey-onerror',e.target.error);
                        res(null)
                      };
                }
                catch(ex){
                    console.log('ImageIndexDB-getDataByKey:'+key+' exception:',ex)
                    res(null)
                }
            })
            // if(data) this.cached.set(key,data)
            return data
        }

        updateData(value) {
            var transaction = this.db.transaction(this.storeName, 'readwrite');
            var store = transaction.objectStore(this.storeName);
            store.put(value)
        }

        deleteDataByKey(key) {
            var transaction = this.db.transaction(this.storeName, 'readwrite');
            var store = transaction.objectStore(this.storeName);
            store.delete(key)
            // this.cached.delete(key)
        }

        clearObjectStore() {
            var transaction = this.db.transaction(this.storeName, 'readwrite');
            var store = transaction.objectStore(this.storeName);
            store.clear();
        }
        clear(){
            console.log('call imDb-clear()')
            this.clearObjectStore()
        }

        deleteObjectStore() {
            var transaction = this.db.transaction(this.storeName, 'versionchange');
            this.db.deleteObjectStore(this.storeName);
        }

        fetchStoreByCursor() {
            var transaction = this.db.transaction(this.storeName);
            var store = transaction.objectStore(this.storeName);
            var request = store.openCursor();
            request.onsuccess = function (e) {
                var cursor = e.target.result;
                if (cursor) {
                    console.log('key:'+cursor.key);
                    var value = cursor.value;
                    console.log(JSON.stringify('value:',value));
                    cursor.continue();
                }
            };
        }
        async getAllDatas() {
            var transaction = this.db.transaction(this.storeName);
            var store = transaction.objectStore(this.storeName);
            var index = store.index("key");
            var request = index.openCursor(null, IDBCursor.prev);
            let results = []
            await new Promise((res)=>{
                request.onsuccess = function (e) {
                    var cursor = e.target.result;
                    if (cursor) {
                        results.push(cursor.value)
                        cursor.continue();
                    }else{
                        res(results)
                    }
                }
            })
            return results
        }
    }
    async  function msleep(ms){
      return new Promise((resolve)=>{
        setTimeout(()=>resolve(true),ms)
      })
    }
    window.msleep = msleep
    // test()
    const ifileDb = new IFileIndexDB('ifiledb','ifilecache');
    ifileDb.openDB();
    window.ifileDb = ifileDb;

    // const filesDb = new IFileIndexDB('files-db','files-store',false);
    // filesDb.openDB();
    // window.filesDb = filesDb;

    // setTimeout(() => {
    //   g_xdraw_start_record()
    // }, 1000);
    // setTimeout(()=>{
    //   // let els = document.getElementsByClassName('excalidraw__canvas')
    //   // console.log('excalidraw__canvas-els:',els)
    //   // if(!els ||els.length<=0){
    //   //   return console.log('excalidraw__canvas-els is empty')
    //   // }
    //   // let base64 = els[0].toDataURL('image/webp',0.9)
    //   // console.log('excalidraw__canvas-els-base64:',base64)
    //   let fileBlob = g_xdraw_stop_record()
    //   console.log('g_xdraw_stop_record-fileBlob:',fileBlob)
    // },8000)

    window.addEventListener('message',async function(e){
      console.log('msg-data:',e)
      if(!e || !e.data) return 
      let obj = null;
      try{
        obj = JSON.parse(e.data)
      }catch(ex)
      {

      }
      if(!obj) return 
      if(obj.type == 'g_xdraw_start_record') {
        window.g_record_base64 = g_xdraw_start_record()
        console.log('g_record_base64:',g_record_base64)
      }
      else if(obj.type == 'g_xdraw_start_record_editor') {
        window.g_record_base64 = g_xdraw_start_record(true)
        console.log('g_record_base64:',g_record_base64)
      }
      else if(obj.type == 'g_xdraw_stop_record'){
        let videoBlob = await g_xdraw_stop_record()
            //将视频文件保存至indexDB中，以发送给头榜
        var binaryData = await new Promise((res)=>{
          var reader = new FileReader();
          reader.onload = function (e) {
              res(e.target.result);
          }
          reader.readAsArrayBuffer(videoBlob);
        })
        ifileDb.deleteDataByKey('from.dtns.xdraw.creator.recorder')
        let data = {base64:window.g_record_base64,video_data:binaryData}
        ifileDb.addData({key:'from.dtns.xdraw.creator.recorder', data})
        const xmsgObj = { xtype: 'dtns.xdraw.creator2xdraw.record.xmsg', xmsg: 'from dtns.xdraw.creator' };
			  window.top.postMessage( JSON.stringify( xmsgObj ), '*' );
        console.log('g_xdraw_stop_record-videoBlob:',videoBlob,'postMessage-xmsgObj:',xmsgObj)
      } 
    },false)

    function get_xdraw_canvas()
    {
      // return get_xdraw_canvas_editor()

      let els = document.getElementsByClassName('excalidraw__canvas')
      console.log('excalidraw__canvas-els:',els)
      if(!els ||els.length<=0){
        console.log('excalidraw__canvas-els is empty')
        return {canvas:null,base64:null}
      }
      let base64 = els[0].toDataURL('image/webp',0.9)
      console.log('excalidraw__canvas-els-base64:',base64)

      //合并了这两个canvas，才能更好的录制视频
      let newCanvas = document.createElement("canvas");
      newCanvas.width = els[0].width;
      newCanvas.height = els[0].height;
      let context = newCanvas.getContext("2d");
      //这里很关键
      window.g_timer_id =  setInterval(()=>{
        //加了这个会闪烁
        if(newCanvas.width!=els[0].width || newCanvas.height!=els[0].height)//加了判断，就不会闪烁那么厉害（只有变化宽度或高度时才会闪烁）
        {
          newCanvas.width = els[0].width;
          newCanvas.height = els[0].height;
        }
        context.drawImage(els[1], 0, 0);
        context.drawImage(els[0], 0, 0);
      },0)
      return {canvas:newCanvas,base64}
    }

    function get_xdraw_canvas_editor()
    {
      let els = document.getElementsByClassName('excalidraw__canvas')
      console.log('excalidraw__canvas-els:',els)
      if(!els ||els.length<=0){
        console.log('excalidraw__canvas-els is empty')
        return {canvas:null,base64:null}
      }
      let base64 = els[0].toDataURL('image/webp',0.9)
      console.log('excalidraw__canvas-els-base64:',base64)

      let newCanvas = document.createElement("canvas");
      let context = newCanvas.getContext("2d");
      let scale = 2
      newCanvas.width = window.innerWidth*scale
      newCanvas.height = window.innerHeight*scale

      window.g_timer_id =  setInterval(()=>{
        //加了这个会闪烁
        if(newCanvas.width!=window.innerWidth*scale || newCanvas.height!=window.innerHeight*scale)//加了判断，就不会闪烁那么厉害（只有变化宽度或高度时才会闪烁）
        {
          newCanvas.width = window.innerWidth*scale;
          newCanvas.height = window.innerHeight*scale;
        }

        console.log('newCanvas-w:',newCanvas.width,newCanvas.height)

        html2canvas(document.body,{ scale}).then(function(canvas) {
          // document.body.appendChild(canvas);
          context.drawImage(canvas, 0, 0);
        });
      },0)

      return {canvas:newCanvas,base64}
    }


    window.g_xdraw_start_record = function(editoFlag = false)
    {
      let {canvas,base64} = editoFlag ? get_xdraw_canvas_editor() : get_xdraw_canvas() 
      if(!canvas) return false
      console.log('g_xdraw_start_record-canvas:',canvas,base64)
      var context = canvas.getContext('2d');
      // context.fillStyle = 'rgba(255,255,255,1)';//设置为白色背景

      let allChunks=[];
      let stream=canvas.captureStream(24); // 60 FPS recording
      let recorder=new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp8,opus',
      });
      window.g_xdraw_recorder = recorder
      window.g_xdraw_recorder_chunks = allChunks
      // canvas 录制回调
      let last_data_time = Date.now()
      let last_buff = null
      window.g_xdraw_recorder_start_time = Date.now()
      recorder.ondataavailable=async e=>{
        console.log('e.data-len:',e.data.size,e.data)
        let new_time = Date.now()
        console.log('last_data_time-sub:',new_time - last_data_time)
        last_data_time = new_time
        allChunks.push(e.data);
      }
      recorder.start(10);
      return base64
    }
    window.g_xdraw_stop_record =async function()
    {
      if(typeof g_xdraw_recorder=='undefined' || !window.g_xdraw_recorder){
        console.log('xdraw-recorder is null')
        return null
      }
      g_xdraw_recorder.stop(0)
      let duration = Date.now() - g_xdraw_recorder_start_time
      let videoBlob = new Blob(g_xdraw_recorder_chunks, { 'type' : 'video/webm' })

      //https://blog.csdn.net/qq_36958916/article/details/108529705
      videoBlob = await new Promise((res)=>{
        ysFixWebmDuration(videoBlob, duration, function (fixedBlob) {
            console.log('fixedBlob:',fixedBlob)
            res(fixedBlob)
        });
      })

      var myUrl = URL.createObjectURL(videoBlob)
      downloadFile(myUrl,'3deditor-record-'+Date.now()+'.webm')
      window.g_xdraw_recorder_chunks = null
      clearInterval(window.g_timer_id)
      return videoBlob
    }
    function downloadFile(url,name='默认文件名')
    {
      var a = document.createElement("a")//创建a标签触发点击下载
      a.setAttribute("href",url)//附上
      a.setAttribute("download",name)
      a.setAttribute("target","_blank")
      let clickEvent = document.createEvent("MouseEvents");
      clickEvent.initEvent("click", true, true);
      a.dispatchEvent(clickEvent);
    }

    window.g_post_message = function(obj)
    {
      console.log('xdraw-build-send_msg_obj:',obj)//,filesDb.db)
      if(!ifileDb.db) return console.log('ifileDb.db is null')
      ifileDb.deleteDataByKey('from.dtns.xdraw.creator.json')
      ifileDb.addData({key:'from.dtns.xdraw.creator.json',data:obj})

      // filesDb.deleteDataByKey('test-file-key')
      // obj.timenow =Date.now() 
      // filesDb.addDataByKey(obj,'test-file-key')

      const xmsgObj = { xtype: 'dtns.xdraw.creator2xdraw', xmsg: 'from dtns.xdraw.creator' };
			window.top.postMessage( JSON.stringify( xmsgObj ), '*' );
    }

      // need to load this script dynamically bcs. of iframe embed tracking
      var scriptEle = document.createElement("script");
      scriptEle.setAttribute(
        "src",
        "https://scripts.simpleanalyticscdn.com/latest.js",
      );
      scriptEle.setAttribute("type", "text/javascript");
      scriptEle.setAttribute("defer", true);
      scriptEle.setAttribute("async", true);
      // if iframe
      if (window.self !== window.top) {
        scriptEle.setAttribute("data-auto-collect", true);
      }

      document.body.appendChild(scriptEle);

      // if iframe
      if (window.self !== window.top) {
        scriptEle.addEventListener("load", () => {
          if (window.sa_pageview) {
            window.window.sa_event(action, {
              category: "iframe",
              label: "embed",
              value: window.location.pathname,
            });
          }
        });
      }
    </script>
    <script src="./fix-webm-duration.js"></script>
    <script src="../html2canvas.min.js"></script>
    <!-- end LEGACY GOOGLE ANALYTICS -->
    
  </body>
</html>
